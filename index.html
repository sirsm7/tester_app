<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem e-Sijil JPN Melaka</title>
	
	<link rel="icon" type="image/png" href="https://i.postimg.cc/jdp3yqpZ/logotech.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Guna fon Oswald sebagai default */
        body {
            font-family: 'Oswald', sans-serif;
        }

        /* Paparan Sijil (Mesra Mudah Alih) */
        #sijil-wrapper {
            width: 100%;
            max-width: 210mm;
            aspect-ratio: 210 / 297;
            height: auto;
            position: relative;
            background-size: 100% 100%;    /* Kekal stretch */
            background-position: center;
            background-repeat: no-repeat;
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            /* Fail .png anda dikekalkan seperti dalam kod asal anda */
            background-image: url('./sijil_techlym.png?v=1');
        }

        .sijil-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
            color: black;
            padding: 0 10%;
            box-sizing: border-box;
        }

        /* --- PERUBAHAN CSS CETAK BERMULA DI SINI --- */

        /* NOTA: Blok @page telah dipadamkan 
           untuk beralih kepada logik saiz pixel.
        */

        /* Blok Cetakan yang Dibaiki (Mengikut Logik Contoh Kod) */
        @media print {
            
            /* 1. Sembunyikan SEMUA elemen secara lalai */
            body * {
                visibility: hidden;
            }

            /* 2. Sembunyikan 'container' butang cetak (ID ditambah dalam JS) */
            #print-button-container {
                display: none;
            }

            /* 3. Tunjukkan 'container' sijil dan sijil itu sendiri */
            #sijil-container, #sijil-wrapper, #sijil-wrapper * {
                visibility: visible;
            }
            
            /* 4. Reset semua 'parent' yang mungkin mengganggu */
            body, html, .max-w-4xl, .p-6, #tab-content-3, #sijil-container { /* DIKEMASKINI: Tukar tab-content-2 ke tab-content-3 */
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                position: static !important; /* Pastikan tiada 'parent' yang 'relative' */
            }

            /* 5. Ambil alih halaman dengan sijil */
            #sijil-wrapper {
                position: absolute !important; /* Paksa */
                left: 0;
                top: 0;
                width: 210mm;  /* Pixel A4 (Logik Prototaip) */
                height: 297mm; /* Pixel A4 (Logik Prototaip) */
                max-width: none;
                aspect-ratio: auto;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                background-size: 100% 100% !important;

                /* --- PEMBETULAN DI SINI --- */
                /* Ini MEMAKSA imej latar dicetak, walaupun 'Background graphics' ditutup */
                -webkit-print-color-adjust: exact !important; /* Untuk Chrome/Safari/Edge */
                print-color-adjust: exact !important;         /* Standard */
                /* --- TAMAT PEMBETULAN --- */
            }

            /* 7. Pastikan teks sijil (position: absolute) juga nampak */
            .sijil-text {
                visibility: visible;
            }
        }
        /* --- PERUBAHAN CSS CETAK TAMAT DI SINI --- */
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
        
        <header>
            <img 
                src="https://i.postimg.cc/prtyDFJQ/tech2025.png" 
                alt="Header Sistem e-Sijil" 
                class="w-full h-auto"
            >
        </header>

        <nav class="flex border-b">
            <button id="tab-btn-1" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out">
                Arahan Penggunaan
            </button>
            <button id="tab-btn-2" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out">
                Daftar Kehadiran
            </button>
            <button id="tab-btn-3" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out">
                Semak Sijil
            </button>
            
            <button id="tab-btn-4" class="tab-button flex-1 py-4 px-6 text-center font-medium text-gray-700 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out hidden md:flex">
                Rumusan
            </button>
        </nav>

        <div class="p-6 md:p-8">
            
            <div id="tab-content-1" class="tab-content space-y-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Selamat Datang!</h2>
                
                <div>
                    <h3 class="text-xl font-bold mb-3">üìú Cara Dapatkan Sijil Anda</h3>
                    <ol class="list-decimal list-inside space-y-2 pl-4 text-gray-700">
                        <li>Pergi ke tab <strong>Daftar Kehadiran</strong>.</li>
                        <li>Isi nama penuh (HURUF BESAR), No. KP, dan maklumat lain dengan betul.</li>
                        <li>Tekan butang <strong>Hantar Pendaftaran</strong>.</li>
                        <li>Bila pendaftaran berjaya, pergi ke tab <strong>Semak Sijil</strong>.</li>
                        <li>Masukkan No. Kad Pengenalan anda (12 digit tanpa '-') dan tekan <strong>Cari</strong>.</li>
                        <li>Sijil anda akan muncul! Tekan butang <strong>Cetak / Simpan PDF</strong>.</li>
                    </ol>
                </div>

                <div>
                    <h3 class="text-xl font-bold mb-3">üñ®Ô∏è PENTING! Tetapan Cetak (PC/Mac Sahaja)</h3>
                    <p class="mb-4 text-gray-700">
                        Arahan di bawah adalah khusus untuk pelayar (browser) <strong>Google Chrome di PC atau Mac</strong>.
                        Tetapan ini mungkin tiada atau berbeza jika anda buka di telefon bimbit atau browser lain (seperti Firefox/Safari).
                    </p>
                    
                    <ul class="list-disc list-inside space-y-2 pl-4 text-gray-700">
                        <li><strong>Destinasi</strong> (Destination): Pastikan ia <strong>Simpan sebagai PDF</strong> (Save as PDF).</li>
                        <li><strong>Saiz Kertas</strong> (Paper size): Mesti pilih <strong>A4</strong>.</li>
                        <li><strong>Susun Atur</strong> (Layout): Mesti pilih <strong>Portrait</strong>.</li>
                        <li><strong>Margin</strong> (Margins): Mesti pilih <strong>None</strong> (Tiada).</li>
                        <li class="font-bold text-red-600"><strong>Skala</strong> (Scale): Pilih <strong>Custom</strong>, dan taip nombor <strong>150</strong>.</li>
                    </ul>
                    
                    <blockquote class="mt-4 p-4 border-l-4 border-blue-400 bg-blue-50 text-blue-800">
                        <strong>Tips:</strong> Sentiasa semak <i>preview</i> sijil. Jika nampak elok dan penuh satu muka surat (tiada muka surat kedua yang kosong), barulah tekan butang <strong>Save</strong> (Simpan).
                    </blockquote>
                </div>
            </div>

            <div id="tab-content-2" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Borang Pendaftaran Kehadiran</h2>
                <form id="form-pendaftaran" class="space-y-6">
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Penuh (HURUF BESAR)</label>
                        <input type="text" id="nama" name="nama" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required
                               oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div>
                        <label for="nokp" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan (12 digit, tanpa '-')</label>
                        <input type="text" id="nokp" name="nokp" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required
                               pattern="[0-9]{12}" maxlength="12" title="Sila masukkan 12 digit nombor KP tanpa sempang.">
                    </div>
                    <div>
                        <label for="negeri" class="block text-sm font-medium text-gray-700 mb-1">Negeri</label>
                        <select id="negeri" name="negeri" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                            <option value="">-- Sila Pilih Negeri --</option>
                            <option value="PAHANG">PAHANG</option>
                            <option value="PERAK">PERAK</option>
                            <option value="TERENGGANU">TERENGGANU</option>
                            <option value="PERLIS">PERLIS</option>
                            <option value="SELANGOR">SELANGOR</option>
                            <option value="NEGERI SEMBILAN">NEGERI SEMBILAN</option>
                            <option value="JOHOR">JOHOR</option>
                            <option value="KELANTAN">KELANTAN</option>
                            <option value="KEDAH">KEDAH</option>
                            <option value="PULAU PINANG">PULAU PINANG</option>
                            <option value="MELAKA">MELAKA</option>
                            <option value="SABAH">SABAH</option>
                            <option value="SARAWAK">SARAWAK</option>
                            <option value="WILAYAH PERSEKUTUAN KUALA LUMPUR">WILAYAH PERSEKUTUAN KUALA LUMPUR</option>
                            <option value="WILAYAH PERSEKUTUAN LABUAN">WILAYAH PERSEKUTUAN LABUAN</option>
                            <option value="WILAYAH PERSEKUTUAN PUTRAJAYA">WILAYAH PERSEKUTUAN PUTRAJAYA</option>
                        </select>
                    </div>
                    <div id="daerah-melaka-container" class="hidden space-y-1">
                        <label for="daerah" class="block text-sm font-medium text-gray-700">Daerah (Melaka)</label>
                        <select id="daerah" name="daerah" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <option value="">-- Sila Pilih Daerah --</option>
                            <option value="ALOR GAJAH">ALOR GAJAH</option>
                            <option value="JASIN">JASIN</option>
                            <option value="MELAKA TENGAH">MELAKA TENGAH</option>
                        </select>
                    </div>
                    <div>
                        <label for="peranan" class="block text-sm font-medium text-gray-700 mb-1">Peranan</label>
                        <select id="peranan" name="peranan" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                            <option value="">-- Sila Pilih Peranan --</option>
                            <option value="MURID / PELAJAR">MURID / PELAJAR</option>
                            <option value="GURU">GURU</option>
                            <option value="PEGAWAI DI JPN">PEGAWAI DI JPN</option>
                            <option value="PEGAWAI DI PPD">PEGAWAI DI PPD</option>
                            <option value="IBU BAPA">IBU BAPA</option>
                        </select>
                    </div>
                    <div>
                        <label for="sekolah" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah / Jabatan (HURUF BESAR)</label>
                        <input type="text" id="sekolah" name="sekolah" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               oninput="this.value = this.value.toUpperCase()">
                        <p id="sekolah-helper" class="text-xs text-gray-500 mt-1">Wajib diisi jika peranan anda GURU, MURID, PEGAWAI JPN, atau PEGAWAI PPD.</p>
                    </div>
                    <div>
                        <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Hantar Pendaftaran
                        </button>
                    </div>
                </form>
            </div>

            <div id="tab-content-3" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Semakan Sijil</h2>
                <form id="form-semakan" class="flex flex-col sm:flex-row gap-4 mb-6">
                    <div class="flex-grow">
                        <label for="nokp-semak" class="block text-sm font-medium text-gray-700 mb-1">No. Kad Pengenalan</label>
                        <input type="text" id="nokp-semak" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan 12 digit No. KP" pattern="[0-9]{12}" maxlength="12" required>
                    </div>
                    <div class="flex items-end gap-2">
                        <button type="submit" id="search-btn" class="w-full sm:w-auto flex justify-center py-2 px-6 border border-transparent rounded-md shadow-sm text-lg font-medium text-black bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-400 transition duration-150 ease-in-out">
                            Cari
                        </button>
                        <button type="button" id="reset-btn" class="w-full sm:w-auto flex justify-center py-2 px-6 border border-gray-300 rounded-md shadow-sm text-lg font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            Reset
                        </button>
                    </div>
                </form>
                
                <div id="sijil-container" class="mt-6">
                    </div>
            </div>

            <div id="tab-content-4" class="tab-content hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Rumusan Kehadiran</h2>
                
                <div id="rumusan-global-container" class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold mb-4">Rumusan Keseluruhan</h3>
                    </div>
                
                <h3 class="text-xl font-bold mb-4">Pecahan Mengikut Negeri</h3>
                <div id="rumusan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    </div>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-8">
        Hakcipta Terpelihara #TEAMjpnmelaka
    </footer>

    <script type="module">
        // --- 3. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://qixtrxechyvxjdxthfrb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpeHRyeGVjaHl2eGpkeHRoZnJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3Njg1NDcsImV4cCI6MjA3NzM0NDU0N30.emTaRn3JyI5hivpKxUL9kqmiV1TAJmH3oAohgBT-2eI';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- KONFIGURASI SIJIL (DIKEMASKINI) ---
        // Kedudukan diubah kepada 45% (atas sedikit) berdasarkan permintaan
        const POSISI_NAMA = '30%'; 

        // --- ELEMEN DOM (DIKEMASKINI UNTUK TAB BARU) ---
        const tabButtons = {
            btn1: document.getElementById('tab-btn-1'), // Arahan
            btn2: document.getElementById('tab-btn-2'), // Daftar
            btn3: document.getElementById('tab-btn-3'), // Semak
            btn4: document.getElementById('tab-btn-4'), // Rumusan
        };
        const tabContents = {
            content1: document.getElementById('tab-content-1'), // Arahan
            content2: document.getElementById('tab-content-2'), // Daftar
            content3: document.getElementById('tab-content-3'), // Semak
            content4: document.getElementById('tab-content-4'), // Rumusan
        };
        
        // Borang Pendaftaran (Tab 2)
        const formPendaftaran = document.getElementById('form-pendaftaran');
        const negeriSelect = document.getElementById('negeri');
        const daerahContainer = document.getElementById('daerah-melaka-container');
        const daerahSelect = document.getElementById('daerah');
        const perananSelect = document.getElementById('peranan');
        const sekolahInput = document.getElementById('sekolah');
        const submitBtn = document.getElementById('submit-btn');

        // Borang Semakan (Tab 3)
        const formSemakan = document.getElementById('form-semakan');
        const nokpSemakInput = document.getElementById('nokp-semak');
        const sijilContainer = document.getElementById('sijil-container');
        const searchBtn = document.getElementById('search-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Rumusan (Tab 4)
        const rumusanGlobalContainer = document.getElementById('rumusan-global-container');
        const rumusanContainer = document.getElementById('rumusan-container');
        const perananWajibSekolah = ['MURID / PELAJAR', 'GURU', 'PEGAWAI DI JPN', 'PEGAWAI DI PPD'];
        const senaraiNegeri = [
            'JOHOR', 'KEDAH', 'KELANTAN', 'MELAKA', 'NEGERI SEMBILAN', 'PAHANG', 'PERAK', 
            'PERLIS', 'PULAU PINANG', 'SABAH', 'SARAWAK', 'SELANGOR', 'TERENGGANU', 
            'WILAYAH PERSEKUTUAN KUALA LUMPUR', 'WILAYAH PERSEKUTUAN LABUAN', 'WILAYAH PERSEKUTUAN PUTRAJAYA'
        ];
        const senaraiPeranan = ['MURID / PELAJAR', 'GURU', 'PEGAWAI DI JPN', 'PEGAWAI DI PPD', 'IBU BAPA'];

        // --- (PERUBAHAN 1: TAMBAH PEMETAAN NAMA PAPARAN) ---
        const namaPaparanPeranan = {
            'MURID / PELAJAR': 'MURID',
            'GURU': 'GURU',
            'PEGAWAI DI JPN': 'JPN',
            'PEGAWAI DI PPD': 'PPD',
            'IBU BAPA': 'IBU BAPA'
        };


        // --- FUNGSI UTAMA ---

        // Fungsi untuk tukar tab (guna bg-red-600)
        function showTab(tabId) {
            Object.values(tabContents).forEach(content => content.classList.add('hidden'));
            // Guna bg-red-600 untuk tab aktif
            Object.values(tabButtons).forEach(btn => btn.classList.remove('bg-red-600', 'text-white')); 
            
            tabContents[`content${tabId}`].classList.remove('hidden');
            tabButtons[`btn${tabId}`].classList.add('bg-red-600', 'text-white'); // Guna bg-red-600

            // DIKEMASKINI: Tukar '3' ke '4' untuk Rumusan
            if (tabId === '4') {
                loadRumusan();
            }
        }

        // --- LOGIK TAB 2: PENDAFTARAN ---

        negeriSelect.addEventListener('change', () => {
            if (negeriSelect.value === 'MELAKA') {
                daerahContainer.classList.remove('hidden');
                daerahSelect.required = true;
            } else {
                daerahContainer.classList.add('hidden');
                daerahSelect.required = false;
                daerahSelect.value = '';
            }
        });

        perananSelect.addEventListener('change', () => {
            if (perananWajibSekolah.includes(perananSelect.value)) {
                sekolahInput.required = true;
                document.getElementById('sekolah-helper').classList.add('text-red-500', 'font-medium');
            } else {
                sekolahInput.required = false;
                document.getElementById('sekolah-helper').classList.remove('text-red-500', 'font-medium');
            }
        });

        // Hantar borang pendaftaran (dengan SweetAlert)
        formPendaftaran.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menghantar...';

            const formData = new FormData(formPendaftaran);
            const dataObj = {
                nama: formData.get('nama'),
                nokp: formData.get('nokp'),
                negeri: formData.get('negeri'),
                daerah: formData.get('negeri') === 'MELAKA' ? formData.get('daerah') : null,
                peranan: formData.get('peranan'),
                sekolah: formData.get('sekolah') || null,
            };

            if (perananWajibSekolah.includes(dataObj.peranan) && !dataObj.sekolah) {
                // Guna SweetAlert untuk ralat validasi
                Swal.fire({
                    icon: 'error',
                    title: 'Borang Tidak Lengkap',
                    text: 'Nama Sekolah / Jabatan wajib diisi untuk peranan anda.',
                });
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hantar Pendaftaran';
                return;
            }

            try {
                // (DIKEMAS KINI) Guna 'upsert' untuk membenarkan kemas kini jika No KP wujud
                const { data, error } = await db
                    .from('peserta')
                    .upsert(dataObj, { onConflict: 'nokp' }) // Jika 'nokp' wujud, ia akan 'update'
                    .select();
                
                if (error) {
                    // Ralat 23505 (unique violation) tidak akan berlaku lagi
                    // tetapi kita masih perlu tangani ralat lain
                    throw error;
                }

                // (DIKEMAS KINI) Mesej SweetAlert
                Swal.fire({
                    icon: 'success',
                    title: 'Pendaftaran Berjaya!',
                    text: 'Maklumat anda telah disimpan/dikemas kini. Sila ke Tab "Semak Sijil".',
                    timer: 2000,
                    showConfirmButton: false
                });
                formPendaftaran.reset();
                daerahContainer.classList.add('hidden');
            
            } catch (error) {
                console.error('Ralat Pendaftaran:', error.message);
                // Guna SweetAlert untuk ralat 'catch'
                Swal.fire({
                    icon: 'error',
                    title: 'Pendaftaran Gagal',
                    text: error.message,
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hantar Pendaftaran';
            }
        });


        // --- LOGIK TAB 3: SEMAKAN SIJIL ---

        // dengan SweetAlert
        formSemakan.addEventListener('submit', async (e) => {
            e.preventDefault();
            sijilContainer.innerHTML = '';
            searchBtn.disabled = true;
            searchBtn.textContent = 'Mencari...';

            const nokp = nokpSemakInput.value;

            try {
                const { data, error } = await db
                    .from('peserta')
                    .select('*')
                    .eq('nokp', nokp)
                    .single();

                if (error || !data) {
                    throw new Error('Data tidak ditemui. Sila pastikan No. KP anda betul atau daftar di Tab 1.');
                }

                generateCertificate(data);
                // Guna SweetAlert 'toast' untuk notifikasi ringkas
                Swal.fire({
                    icon: 'success',
                    title: 'Sijil Ditemui',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                });

            } catch (error) {
                console.error('Ralat Semakan:', error.message);
                // Guna SweetAlert untuk ralat
                Swal.fire({
                    icon: 'error',
                    title: 'Semakan Gagal',
                    text: error.message,
                });
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Cari';
            }
        });

        // Event listener untuk butang Reset
        resetBtn.addEventListener('click', () => {
            nokpSemakInput.value = '';
            sijilContainer.innerHTML = '';
        });

        // --- FUNGSI DIKEMASKINI UNTUK JANA SIJIL ---
        function generateCertificate(peserta) {
            // --- PERUBAHAN JAVASCRIPT DI SINI ---
            sijilContainer.innerHTML = `
                <div class="flex justify-center mb-4" id="print-button-container">
                    <button id="print-button" class="py-2 px-6 bg-green-600 text-white font-bold rounded-md shadow-md hover:bg-green-700 transition duration-150">
                        Cetak / Simpan PDF
                    </button>
                </div>
                <div id="sijil-wrapper">
                
                    <div class="sijil-text" 
                         style="top: ${POSISI_NAMA}; 
                                font-family: Arial, sans-serif; 
                                line-height: 1.2;
								left:12%;
								width:94%">
                        
                        <div style="font-size: 32px; font-weight: bold;">
                            ${peserta.nama}
                        </div>
                        
                        <div style="font-size: 16px; font-style: italic;"> 
                            (${peserta.nokp})
                        </div>
                    </div>
                    </div>
            `;
            // Pasang semula event listener untuk butang cetak yang baru dijana
            document.getElementById('print-button').addEventListener('click', () => {
                window.print();
            });
        }


        // --- LOGIK TAB 4: RUMUSAN (TELAH DITAMBAH BAIK) ---
        
        async function loadRumusan() {
            const loadingHtml = '<p class="text-gray-500">Memuatkan data rumusan...</p>';
            rumusanContainer.innerHTML = loadingHtml;
            rumusanGlobalContainer.innerHTML = loadingHtml;
            
            try {
                // --- MULA PENAMBAHBAIKAN ---
                // Ambil semua data menggunakan paginasi
                let allData = [];
                const CHUNK_SIZE = 1000; // Saiz had lalai Supabase
                let page = 0;
                let hasMore = true;

                while (hasMore) {
                    const { data, error } = await db
                        .from('peserta')
                        .select('negeri, peranan, nokp')
                        .range(page * CHUNK_SIZE, (page + 1) * CHUNK_SIZE - 1); // Cth: 0-999, 1000-1999

                    if (error) throw error; // Ralat akan ditangkap oleh 'catch'

                    if (data) {
                        allData.push(...data); // Tambah data 'chunk' ini ke senarai 'allData'
                    }

                    if (!data || data.length < CHUNK_SIZE) {
                        hasMore = false; // Ini adalah 'page' terakhir
                    } else {
                        page++; // Pindah ke 'page' seterusnya
                    }
                }
                // --- TAMAT PENAMBAHBAIKAN ---

                // 1. Sediakan templat rumusan (per-negeri)
                const summaryNegeri = {};
                senaraiNegeri.forEach(negeri => {
                    summaryNegeri[negeri] = { TOTAL: 0 };
                    senaraiPeranan.forEach(peranan => {
                        summaryNegeri[negeri][peranan] = 0;
                    });
                });
                
                // Sediakan templat rumusan (global)
                let summaryGlobal = {
                    TOTAL: 0,
                    LELAKI: 0,
                    PEREMPUAN: 0,
                    ...Object.fromEntries(senaraiPeranan.map(p => [p, 0])) 
                };

                // 2. Kira data
                // (DIUBAH) Guna 'allData' dan bukan 'data'
                allData.forEach(item => {
                    // Kiraan Per-Negeri
                    if (summaryNegeri[item.negeri] && summaryNegeri[item.negeri][item.peranan] !== undefined) {
                        summaryNegeri[item.negeri][item.peranan]++;
                        summaryNegeri[item.negeri]['TOTAL']++;
                    }

                    // Kiraan Global
                    summaryGlobal.TOTAL++;
                    
                    // Kira Peranan Global
                    if (summaryGlobal[item.peranan] !== undefined) {
                        summaryGlobal[item.peranan]++;
                    }

                    // Kira Jantina Global (Ganjil=Lelaki, Genap=Perempuan)
                    if (item.nokp && item.nokp.length === 12) {
                        const lastDigit = parseInt(item.nokp.slice(-1));
                        if (lastDigit % 2 === 0) {
                            summaryGlobal.PEREMPUAN++;
                        } else {
                            summaryGlobal.LELAKI++;
                        }
                    }
                });
                
                // (BARU) Kira bilangan negeri unik yang telah mendaftar
                // Ini akan mengira ['MELAKA', 'JOHOR', 'MELAKA'] sebagai 2
                // (DIUBAH) Guna 'allData' dan bukan 'data'
                const negeriUnik = new Set(allData.map(item => item.negeri));

                // 3. Jana HTML untuk Rumusan Global
                let globalHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">JUMLAH BESAR</div>
                            <div class="text-3xl font-bold text-red-600">${summaryGlobal.TOTAL}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">LELAKI</div>
                            <div class="text-3xl font-bold text-blue-600">${summaryGlobal.LELAKI}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">PEREMPUAN</div>
                            <div class="text-3xl font-bold text-pink-500">${summaryGlobal.PEREMPUAN}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm font-medium text-gray-500">NEGERI</div>
                            <div class="text-3xl font-bold text-green-600">${negeriUnik.size}</div>
                        </div>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <h4 class="text-lg font-semibold mb-3">Pecahan Mengikut Peranan</h4>
                    <ul class="space-y-2 text-gray-700">
                        ${senaraiPeranan.map(peranan => `
                            <li class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                <span class="font-medium">${peranan}</span>
                                <span class="font-bold text-lg text-red-600">${summaryGlobal[peranan]}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                rumusanGlobalContainer.innerHTML = globalHtml;

                // 4. Jana HTML untuk Pecahan Negeri (Heatmap)
                let heatmapHtml = '';
                const maxTotal = Math.max(...Object.values(summaryNegeri).map(n => n.TOTAL));
                
                senaraiNegeri.forEach(negeri => {
                    const negeriData = summaryNegeri[negeri];
                    const total = negeriData.TOTAL;
                    
                    let bgOpacity = 20; // Default untuk 0
                    if (maxTotal > 0 && total > 0) {
                        bgOpacity = 20 + Math.floor((total / maxTotal) * 80);
                    }
                    
                    // Guna `bg-blue-600` untuk heatmap
                    // --- PERUBAHAN DI SINI ---
                    // Saya tambah 'flex flex-col' untuk membetulkan susunan kad yang meregang
                    heatmapHtml += `
                        <div class="border border-gray-200 rounded-lg shadow-md overflow-hidden bg-blue-600 flex flex-col" style="background-color: rgba(37, 99, 235, ${bgOpacity / 100});">
                            <div class="p-4 ${bgOpacity > 50 ? 'text-white' : 'text-gray-900'}">
                                <h4 class="text-lg font-bold">${negeri}</h4>
                                <p class="text-3xl font-extrabold">${total}</p>
                            </div>
                            <div class="bg-gray-50 p-4 border-t ${bgOpacity > 50 ? 'text-gray-700' : ''}">
                                <ul class="text-sm space-y-1">
                                    ${senaraiPeranan.map(peranan => `
                                        <li class="flex justify-between">
                                            <span>${namaPaparanPeranan[peranan] || peranan}</span>
                                            <span class="font-medium">${negeriData[peranan]}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });
                rumusanContainer.innerHTML = heatmapHtml;

            } catch (error) {
                console.error('Ralat Memuatkan Rumusan:', error.message);
                const errorHtml = `<p class="text-red-500 font-bold">Gagal memuatkan data: ${error.message}</p>`;
                rumusanContainer.innerHTML = errorHtml;
                rumusanGlobalContainer.innerHTML = errorHtml;

                // Papar SweetAlert jika gagal muat rumusan
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Muat Rumusan',
                    text: error.message,
                });
            }
        }


        // --- PENYEDIAAN AWAL (DIKEMASKINI) ---
        
        tabButtons.btn1.addEventListener('click', () => showTab('1'));
        tabButtons.btn2.addEventListener('click', () => showTab('2'));
        tabButtons.btn3.addEventListener('click', () => showTab('3'));
        
        // Event listener untuk Butang 4 masih wujud, ia tidak akan error walaupun butang itu 'hidden'
        // Ia hanya bermakna fungsi 'showTab('4')' tidak akan dipanggil oleh pengguna di mobile
        tabButtons.btn4.addEventListener('click', () => showTab('4'));


        // Juga tukar logik pendaftaran untuk benarkan kemas kini
        // Jika pengguna hantar No KP yang sama, ia akan kemas kini data lama
        // dan tidak akan tunjuk ralat "No KP telah dibatalkan"
        // Ini dicapai dengan menukar .insert() kepada .upsert()
        
        // (Logik pendaftaran telah diubah di atas untuk menggunakan .upsert())

        // DIKEMASKINI: Tunjuk Tab 1 (Arahan) secara lalai
        showTab('1');
    </script>
</body>
</html>